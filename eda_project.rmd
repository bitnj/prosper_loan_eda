Prosper Loan EDA by NEIL SEAS
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Load all of the packages that you end up using in your analysis in this code
# chunk.
setwd('~/Courses/Udacity/Data_Analyst_Nanodegree/eda_project/')
library(ggplot2)
library(lubridate)
library(dplyr)
library(gridExtra)
library(GGally)
library(reshape2)
library(RColorBrewer)
library(maps)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, Load_the_Data}
# Load the Data
loan_data <- read.csv('prosperLoanData.csv')

# convert state abbreviations to state names for later use in the choropleth
loan_data$region <- tolower(state.name[match(loan_data$BorrowerState,
                                             state.abb)])
```

# Introduction

This document is an exploration of the **Prosper Loan Data**, which contains
113,937 observations across 81 variables.  Not all variables will be explored.

# Univariate Plots Section

### Data Overview
```{r echo=TRUE, message=FALSE, warning=FALSE, Univariate_Plots}
str(loan_data)
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
# Convert the LoanOriginationDate from character to Date
loan_data$LoanOriginationDate <- as.Date(loan_data$LoanOriginationDate)

# Get the range of LoanOriginationDate
summary(year(loan_data$LoanOriginationDate))
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data, aes(x = year(LoanOriginationDate))) +
    geom_bar() +
    scale_x_continuous(breaks = seq(2005, 2014))
```

With this histogram, I'm trying to get a sense of the origination volume by
year.  I was curious when the company began so that I could know if this data
set covers the life of the business.  I discovered
[this wiki](https://en.wikipedia.org/wiki/Prosper_Marketplace) which indicated
that the company was open to the public on February 5th, 2006.  It's slightly 
odd that there are 16 loans with LoanOriginationDate values in 2005.

Let's take a finer grain look at the originations by year and quarter.

We need to adjust the factor levels for LoanOriginationQuarter since they are
not in chronological order.

```{r echo = FALSE, message=FALSE, warning=FALSE}
loan_data$LoanOriginationQuarter <- factor(loan_data$LoanOriginationQuarter,
                                           levels = c('Q4 2005', 'Q1 2006',
                                                      'Q2 2006', 'Q3 2006',
                                                      'Q4 2006', 'Q1 2007',
                                                      'Q2 2007', 'Q3 2007',
                                                      'Q4 2007', 'Q1 2008',
                                                      'Q2 2008', 'Q3 2008',
                                                      'Q4 2008', 'Q1 2009',
                                                      'Q2 2009', 'Q3 2009',
                                                      'Q4 2009', 'Q1 2010',
                                                      'Q2 2010', 'Q3 2010',
                                                      'Q4 2010', 'Q1 2011',
                                                      'Q2 2011', 'Q3 2011',
                                                      'Q4 2011', 'Q1 2012',
                                                      'Q2 2012', 'Q3 2012',
                                                      'Q4 2012', 'Q1 2013',
                                                      'Q2 2013', 'Q3 2013',
                                                      'Q4 2013', 'Q1 2014'))
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data, aes(x = LoanOriginationQuarter)) +
    geom_bar() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

There are two interesting observations about this histogram.  The first is the
complete drop off in originations in **Q2 2009** (there isn't any data for 
Q1 2009).  My initial thought was that this reflected the impact of the
financial crisis of 2007-2008, but I would not expect originations to drop to
zero.

In reading the [wikipedia](https://en.wikipedia.org/wiki/Prosper_Marketplace)
article mentioned previously, it seems that this gap in originations was
due to a lawsuit.  It still may be the case that the financial crisis
contributed to the drop in volume.  If we had time-series data we could
look for deteriorating performance (i.e. increasing delinquencies) during the
financial crisis.

In December 2010, Prosper made a change to its business model.  Prior to that
date interest rates were set by investors through a **Dutch style auction**.
The current business model has fixed rate loans with the rate set by an internal
loan pricing and scoring algorithm.  Any analysis should probably treat these
as two separate data sets, but first let's see if we can find the actual point
that Prosper scores came into use.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data, aes(x = LoanOriginationQuarter, fill = 
                                 is.na(ProsperScore))) +
    geom_bar()  +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

The field description file says the ProsperScore is applicable to loans
originated after July 2009.  The graph above confirms that information.

One potential avenue of investigation would be to
look at the characteristics of the borrowers from these two subsets of the data.
Did the introduction of the ProsperScore coincide with tighter lending criteria
(higher credit scores, lower debt to income)?

Let's split the data into loans originated prior to the introduction of
Prosper scores and those originated after.

```{r echo = FALSE, message=FALSE, warning=FALSE}
# update 'True' and 'False' to be boolean rather than text
loan_data$IsBorrowerHomeowner <- 
    ifelse(loan_data$IsBorrowerHomeowner == 'True', TRUE, FALSE)

loan_data$IncomeVerifiable <-
    ifelse(loan_data$IncomeVerifiable == 'True', TRUE, FALSE)

# let's add a field to the loan_data set to indicate which set pre_prosper_score
# or prosper_score
loan_data$prosper_score <- (loan_data$LoanOriginationDate > '2009-06-30')
loan_data_pre_prosper_score <- subset(loan_data, !prosper_score)
loan_data_prosper_score <- subset(loan_data, prosper_score)
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data, aes(x = Term)) +
    geom_bar()
```

I'm very surprised the Term of the loans is so concentrated at 36 months.  I
was expecting that the Terms would be on the shorter side (<= 60 months), but
with a much more diverse.  Let's see if the BorrowerRate is similarly
concentrated.

```{r echo = FALSE, message=FALSE, warning=FALSE}
grid.arrange(ggplot(data = loan_data, aes(x = BorrowerRate)) +
    geom_histogram(binwidth = .01),
    ggplot(data = loan_data, aes(x = 1, y = BorrowerRate)) +
        geom_boxplot(), nrow = 1)
```

The distribution of interest rates is slightly skewed to the right and also has
some large spikes in the upper tail of the distribution.  These spikes may
be some sort of maximum allowable rate, that is set either internally or is
prescribed by regulations.  There are also a a few outliers with rates above
40%, but these are all prior to the introduction of the Prosper Score.

```{r echo = FALSE, message=FALSE, warning=FALSE}
loan_data_by_year <- group_by(loan_data, date = year(LoanOriginationDate))
loan_data_by_year <- summarise(loan_data_by_year, MaxRate = max(BorrowerRate))

ggplot(data = loan_data_by_year, aes(x = date, y = MaxRate)) +
    geom_line() +
    scale_x_discrete(limits = seq(2005, 2014))
```

The maximum borrower rate declined nearly 5% from 2011 to 2014.  This could
reflect overall market conditions and/or reflect higher credit standards for
borrowers following the introduction of the Prosper Score.

Interesting that there are loans with a zero BorrowerRate. Let's look at a
summary of those loans.

```{r echo = FALSE, message=FALSE, warning=FALSE}
zero_rate_loans <- filter(loan_data, BorrowerRate == 0)
table(zero_rate_loans$CreditGrade)
```

The CreditGrade is not what one would expect for 0% interest rate loans.  Since
there are only 8 loans it isn't going to impact the analysis.

```{r echo = FALSE}
ggplot(data = loan_data_prosper_score, aes(x = ProsperScore)) +
    geom_bar()
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
# set the factor levels to be in order of decreasing quality
loan_data_prosper_score$ProsperRating..Alpha. <- 
    factor(loan_data_prosper_score$ProsperRating..Alpha.,
                                           levels = c('AA', 'A', 'B', 'C',
                                                      'D', 'E', 'HR'))
ggplot(data = loan_data_prosper_score, aes(x = ProsperRating..Alpha.)) +
    geom_bar()
```

It looks like the loans are distributed across the rating categories.  When we
move on to the multivariate analysis we'll want to see how these rating
categories correlate to other attributes.

```{r echo = FALSE, message=FALSE, warning=FALSE}
grid.arrange (ggplot(data = loan_data_prosper_score, aes(x = EstimatedLoss)) +
    geom_histogram(binwidth = .01),
    ggplot(data = loan_data_prosper_score, aes(x = 1, y = EstimatedLoss)) +
        geom_boxplot(), nrow = 1)
```

The bulk of the distribution lies between 0 and 20% estimated loss, though there
are a few outliers.  The estimated loss of the most extreme outliers is 36.6%,
which is higher than the Borrower Rate on the loans.  The estimated return on
these loans is **negative**.

```{r echo = FALSE, message=FALSE, warning=FALSE}
# convert the listing codes from numeric to their text values
key <- data.frame(id = c(0:20), listing = 
                                     c('Not Available', 'Debt Consolidation',
                                       'Home Improvement', 'Business',
                                       'Personal Loan', 'Student Use', 'Auto',
                                       'Other', 'Baby&Adoption', 'Boat',
                                       'Cosmetic Procedure', 'Engagement Ring',
                                       'Green Loans', 'Household Expenses',
                                       'Large Purchases', 'Medical/Dental',
                                       'Motorcycle', 'RV', 'Taxes', 'Vacation',
                                       'Wedding'))

loan_data$listing_category <- key[match(loan_data[['ListingCategory..numeric.']],
                                  key[['id']]), 'listing']

loan_data$listing_category <- factor(loan_data$listing_category, 
                                     levels = c('Not Available', 'Debt Consolidation',
                                       'Home Improvement', 'Business',
                                       'Personal Loan', 'Student Use', 'Auto',
                                       'Other', 'Baby&Adoption', 'Boat',
                                       'Cosmetic Procedure', 'Engagement Ring',
                                       'Green Loans', 'Household Expenses',
                                       'Large Purchases', 'Medical/Dental',
                                       'Motorcycle', 'RV', 'Taxes', 'Vacation',
                                       'Wedding'))

ggplot(data = loan_data, aes(x = listing_category)) +
    geom_bar() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

The majority of loans fall into the **Debt Consolidation** category.  It is
surprising how many are labelled as **Not Available**.  Given the plethora of
categories available I would be a wary of a borrower who lists under this
category.  We'll see if Prosper investors lend at higher rates to these
borrowers.

```{r echo = FALSE, message=FALSE, warning=FALSE}
# use dplyr group_by to group by loans by BorrowerState
loan_data_by_state <- group_by(loan_data, BorrowerState)
# show loan count by state in descending order
loan_count_by_state <- arrange(summarise(loan_data_by_state, loans = n()), 
                               desc(loans))
loan_count_by_state
```

I guess it's not too surprising that a California based company would do most of
its business in California.  The 5,515 records with missing BorrowerState values
is troubling.  The borrower's state should be required information.

```{r  echo = FALSE, message=FALSE, warning=FALSE}
# set the ordering of the EmploymentStatus factor according to the count
loan_data <- within(loan_data, 
    EmploymentStatus <- factor(EmploymentStatus, 
                               levels=names(sort(table(EmploymentStatus),
                                                 decreasing=TRUE))))
                                              
ggplot(data = loan_data, aes(x = EmploymentStatus)) +
    geom_bar()  +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

These are strange categories in that they don't seem mutually exclusive (e.g. 
a borrower can be both **Employed** and **Full-time**).  Does **Not employed**
mean unemployed?  It's also unclear what **Other** could mean in this context.
**Not available** is also peculiar - not sure I would lend to someone who says
there Employment Status isn't available.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data, aes(x = EmploymentStatusDuration)) +
    geom_histogram(bindwidth = 6)
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
summary(loan_data$EmploymentStatusDuration)
```

The EmploymentStatusDuration distribution is skewed to the right as shown in the
graph as well as the value of the mean being significantly larger than the
median.  The summary statistics suggest that the typical borrower
is in their 20s-30s.  Looking at the length of the credit history
may add evidence for that claim.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data, aes(x = IsBorrowerHomeowner)) +
    geom_histogram(stat = "count")
```

The portfolio is roughly split between homeowners and non-homeowners.  It will
be interesting to see if this affects the borrower rate when we look at the
bivariate analysis.

```{r echo = FALSE, message=FALSE, warning=FALSE}
grid.arrange(ggplot(data = loan_data, 
                    aes(x = CreditScoreRangeLower)) +
                 geom_histogram(bindwidth = 10) +
                 scale_x_continuous(limits = c(300, 900)),
    ggplot(data = loan_data, 
           aes(x = 1, y = CreditScoreRangeLower)) +
        geom_boxplot(), 
    ggplot(data = loan_data_prosper_score, 
           aes(x = CreditScoreRangeLower)) +
    geom_histogram(bindwidth = 10) +
        scale_x_continuous(limits = c(300, 900)),
    ggplot(data = loan_data_prosper_score, 
           aes(x = 1, y = CreditScoreRangeLower)) +
        geom_boxplot(),
    nrow = 2)
```

```{r echo = FALSE, message = FALSE, warning = FALSE}
summary(loan_data$CreditScoreRangeLower)
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
summary(loan_data_prosper_score$CreditScoreRangeLower)
```

The **CreditScoreRangeLower** distribution is relatively normal with the
interquartile range squarely in the **Fair** and **Good** credit categories.
It is interesting to note that after the introduction of the Prosper Score there
are no longer any loans with Credit Scores below 600.  This is consistent with
our previous idea that credit standards were tightened when lending resumed in
Q3 2009.

```{r echo = FALSE, message=FALSE, warning=FALSE}
# convert the character string to a date
loan_data$FirstRecordedCreditLine <- as.Date(loan_data$FirstRecordedCreditLine)

ggplot(data = loan_data, aes(x = year(FirstRecordedCreditLine))) +
    geom_histogram(binwidth = 1)
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
summary(year(loan_data$FirstRecordedCreditLine))
```

You must be 18 years old to establish credit.  The median of the
FirstRecordedCreditLine is 1995, so assuming most people choose
to take credit soon after turning 18, and given that our loan data is from the
period 2006 through 2014, our borrowers are roughly 18 years
old + (2006-1995) = 29 to 18 + (2014-1995) = 37.  This is a little higher than I
would have thought based solely on the Employment Duration, but still consistent
with the idea that the core customer of Prosper tends to be younger.

```{r echo = FALSE, message=FALSE, warning=FALSE}
loan_data_DTI_lt_1 <- subset(loan_data, DebtToIncomeRatio <= 1)
grid.arrange(ggplot(data = loan_data_DTI_lt_1, aes(x = DebtToIncomeRatio)) +
    geom_histogram(binwidth = .01) +
    scale_x_continuous(limits = c(0, 1)),
    ggplot(data = loan_data_DTI_lt_1, aes(x = 1, y = DebtToIncomeRatio)) +
        geom_boxplot(), nrow = 1)
```

The distribution of DebtToIncome is fairly normal when looking at the region
between 0 and 1, which is where the vast majority of the observations lie.
There is still a number of outliers.  In the bivariate analysis I would expect
these higher DTI loans to have higher Borrower Rates.

```{r echo = FALSE, message=FALSE, warning=FALSE}
summary(loan_data_pre_prosper_score$DebtToIncomeRatio)
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
summary(loan_data_prosper_score$DebtToIncomeRatio)
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
loan_data$IncomeRange <- factor(loan_data$IncomeRange, levels = 
                                    c('Not displayed', 'Not employed',
                                      '$0', '$1-24,999', '$25,000-49,999',
                                      '$50,000-74,999', '$75,000-99,999',
                                      '$100,000+'))
ggplot(loan_data, aes(x = IncomeRange)) +
    geom_histogram(stat = "count") +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data, aes(x = IncomeVerifiable)) +
    geom_bar() +
    geom_text(stat="count", aes(label = ..count..), vjust = -.5)
```

The majority of borrowers can verify their income.  I would expect this feature
to be associated with the Borrower Rate.  On average we should expect that
borrowers who can not verify their income would get higher interest rates, all
other things being equal.

```{r echo = FALSE, message=FALSE, warning=FALSE}
# add a field indicating whether the loan is active or not based on the
# LoanStatus field
# loan is Inactive when LoanStatus (completed, cancelled, defaulted, chargedoff)
loan_data$active <- !(loan_data$LoanStatus %in%
                               c('Completed', 
                                 'Cancelled', 
                                 'Defaulted',
                                 'Chargedoff'))

active_loans <- filter(loan_data, active)
# drops unused factor levels after the filter
active_loans$LoanStatus <- factor(active_loans$LoanStatus)

# factor levels are not in a logical order
active_loans$LoanStatus <- factor(
    active_loans$LoanStatus, levels = c('FinalPaymentInProgress',
                                        'Current', 'Past Due (1-15 days)',
                                        'Past Due (16-30 days)',
                                        'Past Due (31-60 days)',
                                        'Past Due (61-90 days)',
                                        'Past Due (91-120 days)',
                                        'Past Due (>120 days)'))


inactive_loans <- filter(loan_data, !active)
inactive_loans$LoanStatus <- factor(inactive_loans$LoanStatus)

# factor levels are not in a logical order
inactive_loans$LoanStatus <- factor(
    inactive_loans$LoanStatus, levels = c('Completed', 'Cancelled', 
                                          'Defaulted', 'Chargedoff'))
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = active_loans, aes(x = LoanStatus)) +
    geom_bar() +
    scale_y_log10() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = inactive_loans, aes(x = LoanStatus)) +
    geom_bar() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

As expected, all of the Inactive loans are either Completed, Cancelled,
Charged-off or Defaulted.  At the time this data set was pulled there is very
little delinquency.

Let's dig a little deeper into the Chargeoff and Defaulted categories.

```{r echo = FALSE, message=FALSE, warning=FALSE}
defaulted_loans <- filter(inactive_loans, LoanStatus %in% c('Chargedoff',
                                                            'Defaulted'))
# add a calculation for the number of months between the LoanOriginationDate
# and the ClosedDate of Defaulted and Chargedoff loans.  Chargedoff is just
# a subsequent step of accounting for a default and usually occurs within a
# month of the Default date.
defaulted_loans$months_to_default <- (year(defaulted_loans$ClosedDate) -
    year(defaulted_loans$LoanOriginationDate)) * 12 + 
    (month(defaulted_loans$ClosedDate) - 
         month(defaulted_loans$LoanOriginationDate))

defaulted_loans$defaulted <- TRUE

# add the months_to_default column back to the loan_data dataframe
loan_data <- merge(loan_data, defaulted_loans[, c('LoanKey', 
                                                  'months_to_default',
                                                  'defaulted')],
      by='LoanKey', all.x = TRUE)

loan_data['defaulted'][is.na(loan_data['defaulted'])] <- FALSE

# add the defaulted column to the _prosper_score dataframe so that we can use
# it later
loan_data_prosper_score <- merge(loan_data_prosper_score, 
                                 defaulted_loans[, c('LoanKey',
                                                     'months_to_default',
                                                     'defaulted')],
                                 by='LoanKey', all.x = TRUE)

loan_data_prosper_score['defaulted'][
    is.na(loan_data_prosper_score['defaulted'])] <- FALSE
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
grid.arrange(ggplot(data = defaulted_loans, aes(x = months_to_default)) +
    geom_histogram(binwidth = 1) +
    coord_cartesian(xlim = c(0, 60)),
    ggplot(data = defaulted_loans, aes(x = 1, y = months_to_default)) +
        geom_boxplot() +
        coord_cartesian(ylim = c(0, 60)), nrow = 1)
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
summary(subset(defaulted_loans, prosper_score == FALSE)$months_to_default)
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
summary(subset(defaulted_loans, prosper_score == TRUE &
                   months_to_default > 0)$months_to_default)
```

Interestingly, loans default sooner on average after the introduction of the
Prosper Score, though the distribution is narrower.  Of those borrowers that
default, 50% will defaulted in a small 9 month window between 9 and 19 months
for loans originated with a Prosper Score.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = defaulted_loans, aes(x = year(LoanOriginationDate))) +
    geom_histogram(stat="count")
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
grid.arrange(ggplot(data = loan_data, aes(x = TradesOpenedLast6Months)) +
    geom_bar(),
    ggplot(data = loan_data, aes(x = 1, y = TradesOpenedLast6Months)) +
        geom_boxplot() , nrow = 1)
```

This feature represents the number of credit accounts opened within the last 6
months.  This distribution is highly skewed, with the mode of the distribution
being 0.  Other things being equal, I would expect those borrowers who have
non-zero values for this feature to have higher interest rates.

```{r echo = FALSE, message = FALSE, warning = FALSE}
summary(loan_data$TradesOpenedLast6Months)
```


### What is the structure of your dataset?

The dataset consists of 113,937 loans with 81 variables.

### What is/are the main feature(s) of interest in your dataset?

When looking at financial products such as loans the most important features
are likely to be related to the credit worthiness of the borrower.  
For example, Prosper Score, Credit Score Range Lower or Upper, Income Range, 
Employment Status, Debt to Income Ratio, and BorrowerState are variables of
interest that may help understand the ProsperScore and the likelihood
of repayment.

### What other features in the dataset do you think will help support your \
investigation into your feature(s) of interest?

Variables such as Listing Category, Current Delinquencies, and
Trades Opened Last 6 Months may also provide information about the likelihood of
repayment.

### Did you create any new variables from existing variables in the dataset?

I did create a few new variables during the univariate exploration. The first
two, prosper_score and active are boolean flags.  The field prosper_score
indicates if the loan was originated prior to the introduction of the score or
after (TRUE = after).  Similarly, active is a flag that tags loans according
to their LoanStatus (inactive loans are those with LoanStatus in 'Completed',
'Cancelled', 'Chargedoff', 'Defaulted').  I also created a **months_to_default**
variable to measure the number of months from origination to default for loans
in either the **defaulted** or **charged-off** Loan Status.

### Of the features you investigated, were there any unusual distributions? \
Did you perform any operations on the data to tidy, adjust, or change the form \
of the data? If so, why did you do this?

Yes.  I re-ordered the levels on the variables ProsperRating..Alpha.,
LoanStatus, and LoanOriginationQuarter so that they would reflect an order that
made sense when visualized.  For example, the ProsperRating..Alpha. variable was
re-ordered to go from the best rating to the worst.

# Bivariate Analysis
```{r echo=FALSE, message=FALSE, Bivariate_Plots}
cols_to_keep <- c(6, 10, 13, 17, 18, 22, 27, 35, 37, 39, 43, 47, 48, 64, 81)
ggcorr(data = loan_data_prosper_score[cols_to_keep], geom = 'circle',
       label = TRUE,
       label_size = 3,
       nbreaks = 5,
       hjust = 1,
       layout.exp = 2)
```

Clearly the strongest correlations are between Prosper Score and Estimated Loss
and Borrower Rate and Estimated Loss.  This makes sense because the Prosper
Score is a measure of the riskiness of the borrower and the Borrower Rate
should be a reflection of that riskiness.  The more likely the borrower is to
default on the loan the more Prosper must charge to compensate for that risk.

Let's get a look at the Estimated Loss and Borrower Rate.

```{r echo = FALSE, message = FALSE, warning = FALSE}
ggplot(data = loan_data_prosper_score, aes(x = EstimatedLoss , 
                                           y = BorrowerRate)) +
    geom_point(alpha = 1/3) +
    geom_smooth()
```

The relationship between Estimated Loss and Borrower Rate is linear until the
estimated losses reach approximately 17%.  Beyond that point the Borrower Rate
is already above 30%, which means we are near the maximum rates seen
earlier.  This upper bound on the interest rate will clearly distort the
relationship as we can see above.

I'm curious how closely the Estimated Loss correlates to the Prosper Rating
categories.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data_prosper_score, aes(x = ProsperRating..Alpha., 
                                           y = EstimatedLoss)) +
    geom_boxplot()
```

Clearly, the Prosper scoring algorithm is correlated to the Estimated Loss. It
appears that there isn't any overlap in the rating categories with regard to
Expected Loss.

```{r echo = FALSE, message=FALSE, warning=FALSE}
with(loan_data_prosper_score, tapply(EstimatedLoss, ProsperRating..Alpha., min))
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
with(loan_data_prosper_score, tapply(EstimatedLoss, ProsperRating..Alpha., max))
```

The two summaries above confirm what the boxplot shows, which is that there is
no overlap between the Estimated Loss values across the rating categories.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data_prosper_score, aes(x = ProsperRating..Alpha.,
                                           y = BorrowerRate)) +
    geom_boxplot()
```

Unlike the boxplot of Prosper Rating and Estimated Loss, the number of outliers
in the boxplot above and the overlap across rating categories is curious.
Why would someone in the highest rating category be paying in excess of 15%
interest?  This suggests that there are other factors driving the final Borrower
Rate, which may be reflected in the Prosper Score.

```{r echo=FALSE, message=FALSE, warning=FALSE}
# set the factor levels to be in order of decreasing quality
loan_data$ProsperRating..Alpha. <- factor(loan_data$ProsperRating..Alpha.,
                                           levels = c('AA', 'A', 'B', 'C',
                                                      'D', 'E', 'HR'))

ggplot(data = loan_data, aes(x = ProsperRating..Alpha., 
                             y = CreditScoreRangeLower)) + 
    geom_boxplot() + 
    geom_jitter(alpha = .01) + 
    stat_summary(fun.y = 'mean',
                 geom = 'point',
                 color = 'red',
                 shape = 20,
                 size = 4) + 
    scale_y_continuous(limits = c(300, 900))
```

The boxplot above gives a pretty clear indication that the credit profile of
the borrowers shifted with the introduction of the prosper score in mid-2009.
The pre-prosper score loans have significantly lower credit scores, with the
median being below the median value for all of the Prosper Rating groups (even
the HR - High Risk category).  It also shows the relationship between the
rating categories and the credit score, which is as we would expect.  We can
also see that category C is the most dense rating category, which is consistent
with what we saw in the univariate analysis.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data_prosper_score, aes(x = CreditScoreRangeLower,
                                           y = BorrowerRate)) +
    geom_point(alpha = 1/10, position = position_jitter(width = 5)) +
    geom_smooth()
```

As expected, there is a negative relationship between Borrower Rate and the
Credit Score of the borrower.  As the credit score of the borrower increases
the interest rate decreases.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data_prosper_score, aes(x = ProsperRating..Alpha., 
                                           y = ProsperScore)) +
    geom_boxplot()
```

The relationship between Prosper Score and Prosper Rating is not as strong as I
expected.  Though the general direction of the relationship is what one would
expect, there is quite a lot of variability.  Let's see if there are other
features of the data that may help explain the Prosper Score better.

```{r echo = FALSE, message=FALSE, warning=FALSE}
# prepare the data for use in a heatmap
pScore_cScore <- loan_data_prosper_score[, c(17,27)]
# convert the unique values of Credit Score into column names and the row
# values become the count within each Prosper Score
pScore_cScore <- dcast(pScore_cScore, ProsperScore ~CreditScoreRangeLower)
# drop the NA row
pScore_cScore <- pScore_cScore[1:11,]
row.names(pScore_cScore) <- pScore_cScore$ProsperScore
# drop the Prosper Score column
pScore_cScore <- pScore_cScore[,2:16]
# exclude the NA row from the map and convert to a matrix
pScore_cScore_matrix <- data.matrix(pScore_cScore)

heatmap(pScore_cScore_matrix, Rowv = NA, Colv = NA, 
        col = brewer.pal(9, "Blues"),
        scale = 'column', margins = c(5,5),
        xlab = 'Credit Score',
        ylab = 'Prosper Score')
```

The CreditScoreRangeLower feature would be high on the list of explanatory
variables to include in any model of Prosper Score.  There is a clear positive
correlation between the Credit Score and the Prosper Score.  It's quite
possible that the credit score is an input into the Prosper Score algorithm.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data_prosper_score, aes(x = IsBorrowerHomeowner,
                                           y = BorrowerRate)) +
    geom_boxplot()
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
summary(subset(loan_data_prosper_score, 
               IsBorrowerHomeowner == TRUE)$BorrowerRate)
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
summary(subset(loan_data_prosper_score, 
               IsBorrowerHomeowner == FALSE)$BorrowerRate)
```

As expected, borrowers who are homeowners command lower interest rates on
average than non-homeowners. It is likely that home ownership is correlated with
other features like employment and credit history.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data_prosper_score, aes(x = ProsperScore,
                                           y = InquiriesLast6Months)) +
    geom_point(alpha = 1/10, position = position_jitter(width = .25))
```

Though not particularly strong, there is a relationship between the number of
credit inquiries and the Prosper Score.  This makes sense as it may be an
indication of the need for credit.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = subset(loan_data_prosper_score, DebtToIncomeRatio <= 1),
                     aes(x = ProsperScore, y = DebtToIncomeRatio,
                         group = ProsperScore)) +
    geom_boxplot() +
    coord_cartesian(ylim = c(0, .5))
#    geom_point(alpha = 1/5, position = position_jitter(width = .25)) +
#    geom_smooth()
```

The relationship between Debt to Income Ratio and Prosper Score has
many outliers, which I have cut off using coord_cartesian, but it does show a
negative correlation and is likely a component of the Prosper Scoring algorithm.
It makes sense that a borrower with a high DTI will have less capacity to handle
any financial shocks and may therfore be at higher risk of default.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data_prosper_score, aes(x = ProsperScore,
                                           y = TradesOpenedLast6Months)) +
    geom_point(alpha = 1/5, position = position_jitter(width = .25))

```

Similar to DTI and InquiriesLast6Months, the strength of the relationship 
between TradesOpenedLast6Months and Prosper Score is rather weak.  It still may
be a component of the Prosper Scoring alorithm.  Opening a lot of credit
accounts could be an indication of impending financial stress.

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data, aes(x = listing_category,
                             y = BorrowerRate)) +
    geom_boxplot() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

### Talk about some of the relationships you observed in this part of the \
investigation. How did the feature(s) of interest vary with other features in \
the dataset?

The strongest relationship is that between the Credit Score and the Prosper
Score.  These are important pieces of information to understanding the riskiness
of a loan.  Other features such as the debt to income ratio and recent credit
inquiries have negative relationships to the Prosper Score.

### Did you observe any interesting relationships between the other features \
(not the main feature(s) of interest)?

I was a little surprised that there wasn't a clearer relationship between the
listing category and the borrower rate.  For example, the 'Not Available'
category has one of the lowest average interest rates whereas loans for the Auto
category have a higher average rate.  My hypothesis for this is that Prosper
investors do not have traditional remedies for default, such as repossession of
collateral so there is no longer a distinction between collateralized and
uncollateralized lending.


### What was the strongest relationship you found?
The strongest relationship in the features I investigated was that between
the Prosper Score and the CreditScoreRangeLower.  This suggests that either
Credit Score is used in the formulation of the Prosper Score or that
the Prosper Score algorithm shares some similarities to the algorithm
used for generate Credit Scores.


# Multivariate Plots Section
```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data_prosper_score, aes(x = CreditScoreRangeLower , 
                                           y = ProsperScore,
                                           color = defaulted)) +
    geom_point(alpha = 1/2, position = position_jitter(width = 7))
```

This visualization shows that ProsperScore and Credit Score together do an OK
job at capturing the riskiness of loans.  At each Credit Score level the
defaulted loans group tends to have a lower average ProsperScore

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data_prosper_score, aes(x = factor(ProsperScore),
                                           y = BorrowerRate)) +
    geom_boxplot(aes(fill = defaulted))
```

```{r echo = FALSE, message=FALSE, warning=FALSE}
ggplot(data = loan_data, aes(x = listing_category,
                             y = BorrowerRate, fill = defaulted)) +
    geom_boxplot() +
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))
```

The boxplots above shows loans that default carry higher interest rates on
average, though it is interesting that there are a wide range of outliers
at each Prosper Score.  This is a clear indication that factors other than
Prosper Score determine the Borrower Rate.  The same higher interest rates on
defaulted loans can be seen across the listing categories as well.

```{r echo = FALSE, message=FALSE, warning=FALSE}
loan_data_prosper_score$ProsperScore_bucket <- cut(
    loan_data_prosper_score$ProsperScore, c(1, 4, 6, 8, 11))

ggplot(data = loan_data_prosper_score, aes(y = CreditScoreRangeLower,
                                           x = ProsperScore_bucket,
                                           fill = cut(EstimatedLoss,
                                                   breaks = c(0, .02, .04, .06,
                                                              .09, .12, .15,
                                                              include.lowest =
                                                                  TRUE)))) +
    geom_boxplot() + ylim(c(600, 800)) + labs(aes(fill = 'Estimated Loss'))
    
```

The visualization above shows the relationship we would expect based on the
statements from the Prosper website.  The combination of Prosper Score and
FICO does correlate to the Expected Loss.

```{r echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots}
ggplot(data = loan_data_prosper_score, aes(x = CreditScoreRangeLower, 
                                           y = DebtToIncomeRatio,
                                           colour = defaulted)) +
    geom_point(position = position_jitter(width = 7), alpha = 1/2) +
    scale_color_brewer(type = 'qual', palette = 'Paired') +
    coord_cartesian(ylim = c(0, 1))
```

This scatterplot supports the idea that defaults occur more frequently for
lower credit quality borrowers (lower credit score).  It also gives some
evidence that higher debt to income ratios play a role in defaults.

```{r echo = FALSE, message=FALSE, warning=FALSE}
loan_data_by_state <- group_by(loan_data_prosper_score, region)
# calculate the % of loans that default by state
state_default_rates <- arrange(summarise(loan_data_by_state,
                                         default_rate = sum(defaulted, 
                                                            na.rm=TRUE)/n()),
                               desc(default_rate))
# join our default_rate data to the map information so it can be plotted
map <- inner_join(map_data('state'), state_default_rates, by = "region")
map <- arrange(map, order)
map$state_abb <- state.abb[match(map$region, tolower(state.name))]

# mean lat and long of each state so we can have a location for the
# state abbreviation
cnames <- aggregate(cbind(long, lat) ~ state_abb, data=map, 
                    FUN=function(x)mean(range(x)))

ggplot(data = map, aes(long, lat)) +  
    geom_polygon(aes(group= group, fill = default_rate), colour='white') +
    geom_text(data = cnames, aes(long, lat, label = state_abb), size = 3) +
    coord_map()
```

From the choropleth above we can see a pretty clear pattern of higher default
rates in the Southeast portion of the country.  The only exception to this
is South Dakota, which has the highest default rate in the country.

```{r echo = FALSE, message=FALSE, warning=FALSE}
head(state_default_rates)
```
```{r echo = FALSE, message=FALSE, warning=FALSE}
tail(state_default_rates)
```


# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the \
investigation. Were there features that strengthened each other in terms of \
looking at your feature(s) of interest?

Prosper Score and CreditScoreRangeLower together show a fairly strong
relationship to the EstimatedLoss.  This is consistent with information
provided on the 
[Prosper website](https://www.prosper.com/plp/general-estimated_loss_rates/)
that describes the base estimated loss rate.


### Were there any interesting or surprising interactions between features?

I was surpised by the relatively weak relationships in the features I looked at
such as the number of recent credit inquiries and the debt to income ratio.  It
suggests that perhaps the Prosper Scoring algorithm utilizes many features that
each contribute.  It could also be the case that the 
Prosper Scoring algorithm relies heaviliy on the Credit Score of the borrower
since those scores already take into account a range of borrower features.

### OPTIONAL: Did you create any models with your dataset? Discuss the \
strengths and limitations of your model.

I did tinker with implementing a **logit** model to predict default, but am not
including it here.

------

# Final Plots and Summary

### Plot One
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_One}
ggplot(data = loan_data_prosper_score, aes(y = CreditScoreRangeLower,
                                           x = ProsperScore_bucket,
                                           fill = cut(EstimatedLoss,
                                                   breaks = c(0, .02, .04, .06,
                                                              .09, .12, .15,
                                                              include.lowest =
                                                                  TRUE)))) +
    geom_boxplot() + ylim(c(600, 800)) +
    labs(fill = 'Estimated Loss Range') +
    ggtitle(label = 'Estimated Loss', 
            subtitle = 'by Prosper Score Bucket & Credit Score') +
    labs(x = 'Prosper Score Bucket', y = 'Credit Score')
```

### Description One

This boxplot reflects the 11 Prosper Rating categories grouped into buckets.
Each Prosper Rating bucket is broken down into Estimated Loss range buckets.  On
the y-axis we show the Credit Score.  What this boxplot communicates is the
positive relationship between the internal Prosper Score and the external
Credit Score for the borrowers. The higher Prosper Score buckets contain larger
amounts of loans with lower estimated losses, while the lower Prosper Score
buckets contain more loans from the higher estimated loss buckets.

### Plot Two
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Two}
ggplot(data = loan_data_prosper_score, aes(x = factor(ProsperScore),
                                           y = BorrowerRate)) +
    geom_boxplot(aes(fill = defaulted)) +
    ggtitle(label = 'Borrwer Rate by Prosper Score', 
            subtitle = 'for Defaulted and Non-Defaulted Loans' ) +
    labs(x = 'Prosper Score', y = 'Borrower Rate') +
    labs(fill = 'Defaulted')
```

### Description Two

This boxplot shows the relationship of Borrower Rate to Prosper Score and
further breaks down the relationship by whether the loan defaulted or not.  On
the y-axis we show the interest rate of the loan.  There is a clear pattern of
higher interest rates for lower Proser Scores.  This is as we would expect
because the Prosper Score is an indication of the riskiness of the loan and the
interest rate is the main mechanism to compensate investors for their level of
risk.  What is particularly interest, and an avenue for further investigation,
is the number of outliers.  There are loans with Prosper Scores of 1 (the worst)
with interest rates near those of the highest Prosper Score borrowers.
Similarly, there are loans with the highest Prosper Score with interest rates
near 20%.  Understanding these outliers would probably answer a lot of questions
about the Prosper Scoring algorithm.  Nonetheless, the expected negative
correlation is observed in the data.

### Plot Three
```{r echo=FALSE, message=FALSE, warning=FALSE, Plot_Three}
ggplot(data = map, aes(long, lat)) +  
    geom_polygon(aes(group= group, fill = default_rate), colour='white') +
    geom_text(data = cnames, aes(long, lat, label = state_abb), size = 3) +
    coord_map() +
    ggtitle(label = 'Default Rate', subtitle = 'by State') +
    labs(fill = 'Default Rate') +
    labs(x = 'Longitude', y = 'Latitude')
```

### Description Three

While only a basic choropleth, this visualization shows a cluster of higher
default levels in the southeastern portion of the U.S..  The default rate is
measured as the number of loans with Loan Statuses of either **Defaulted** or
**Chargedoff** in each state as a percentage of all loans originated in that
state.

# Reflection

This exploratory data analysis was challenging.  The large number of features
available in the dataset made it difficult to choose where to
start.  It was also challenging because there are many ways to do things in R.
These are both good things and I feel that I have come through the other side
having gained a lot of valuable practice with R.

My main interest in this dataset is with predicting default so I would try to
dig deeper into the various features that may relate to that outcome.  Since
the dependent variable is binary I would think that a logit model could be a
decent starting point for any time of modeling.  It would also be interesting to
acquire time-series data related to these loans which would allow the next step
of not only predicting default, but when loans will default.